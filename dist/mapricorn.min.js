"use strict";(()=>{var U=Object.defineProperty;var q=(c,t,e)=>t in c?U(c,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):c[t]=e;var a=(c,t,e)=>(q(c,typeof t!="symbol"?t+"":t,e),e);function X(c,t){let e=Math.pow(10,t===void 0?6:t);return Math.round(c*e)/e}var v=class c{constructor(t,e,s){a(this,"lat",0);a(this,"lng",0);a(this,"alt");if(t instanceof c)return t;if(Array.isArray(t)&&typeof t[0]!="object"){if(t.length===3)return new c(t[0],t[1],t[2]);if(t.length===2)return new c(t[0],t[1]);throw new Error("Invalid parameters")}if(t==null)return t;if(typeof t=="object"&&"lat"in t)return new c(t.lat,t.lng,t.alt);if(e===void 0)throw new Error("Invalid parameters");let n=t;if(isNaN(n)||isNaN(e))throw new Error("Invalid LatLng object: ("+n+", "+e+")");this.lat=n,this.lng=e,s!==void 0&&(this.alt=s)}equals(t,e){if(!t)return!1;let s=new c(t);return Math.max(Math.abs(this.lat-s.lat),Math.abs(this.lng-s.lng))<=(e===void 0?1e-9:e)}toString(t){return"LatLng("+X(this.lat,t)+", "+X(this.lng,t)+")"}clone(){return new c(this.lat,this.lng,this.alt)}};var h=class c{static getTilePixelByZoom(t){return 256*(2**t/2**Math.round(t))}static degrees2meters(t,e){let s=e*6378137*Math.PI/180,n=6378137*Math.log(Math.tan(Math.PI/4+t*Math.PI/180/2));return{x:s,y:n}}static meters2degrees(t,e){let s=(2*Math.atan(Math.exp(e/6378137))-Math.PI/2)/Math.PI*180,n=t/6378137/Math.PI*180;return{lat:s,lng:n}}static meters2tile(t,e,s){let n=Math.floor((t+6378137*Math.PI)/(12756274*Math.PI)*2**Math.round(s)),i=Math.floor((1-(e+6378137*Math.PI)/(2*6378137*Math.PI))*2**Math.round(s));return{x:n,y:i}}static degrees2tile(t,e,s){let n=c.degrees2meters(t,e);return c.meters2tile(n.x,n.y,s)}static tile2meters(t,e,s){let n=t/2**Math.round(s)*(12756274*Math.PI)-6378137*Math.PI,i=(1-e/2**Math.round(s))*(2*6378137*Math.PI)-6378137*Math.PI;return{x:n,y:i}}static meter2world(t,e,s){let n=this.getMetersPerPixelByZoom(s),i=t/n,o=-e/n;return{x:i,y:o}}static getZoomByMetersPerPixel(t){return Math.log(2*Math.PI*6378137/(t*256))/Math.log(2)}static getMetersPerTileByZoom(t){return 2*Math.PI*6378137/2**t}static getMetersPerPixelByZoom(t){return 2*6378137*Math.PI/(2**t*256)}};var P=class{constructor(t){a(this,"debug",!1);a(this,"container");a(this,"width","");a(this,"height","");a(this,"canvas");a(this,"mapSource","https://tile.openstreetmap.org/{z}/{x}/{y}.png");a(this,"offScreen");a(this,"useOffScreen",!0);a(this,"gpxData");a(this,"center");a(this,"zoom",1);a(this,"zoomMax",19);a(this,"zoomMin",0);a(this,"latMax",0);a(this,"lngMin",0);a(this,"oldPoint");a(this,"isMoving",!1);a(this,"touchMap",{});a(this,"touchList",[]);a(this,"images",[]);this.center=new v([0,0,0]),t&&(t.mapSource&&(this.mapSource=t.mapSource),t.center&&(this.center=new v(t.center)),t.zoom&&this.setZoom(t.zoom),t.width&&(this.width=t.width),t.height&&(this.height=t.height),t.container&&this.bind(t.container))}bind(t){if(t===void 0)throw new Error("Invalid container");this.container=t,this.setup(),this.resize()}setup(){if(this.container&&(this.container.style.position="relative",this.width&&(this.container.style.width=this.width),this.height&&(this.container.style.height=this.height),!this.canvas)){this.canvas=document.createElement("canvas"),this.container.appendChild(this.canvas),this.canvas.style.width="100%",this.canvas.style.height="100%";let t=this.canvas.getContext("2d");if(!t)return;t.lineWidth=1,t.strokeStyle="#fff",this.canvas.addEventListener("mousedown",this.handlerMouseDown()),this.canvas.addEventListener("mouseup",this.handlerMouseUp()),this.canvas.addEventListener("mousemove",this.handlerMouseMove()),this.canvas.addEventListener("mouseleave",this.handlerMouseLeave()),this.canvas.addEventListener("touchstart",this.handlerTouchStart()),this.canvas.addEventListener("touchend",this.handlerTouchEnd()),this.canvas.addEventListener("touchmove",this.handlerTouchMove()),this.canvas.addEventListener("wheel",this.handlerMouseWheel()),window.addEventListener("resize",this.handlerResize())}}resize(){if(!this.canvas)return;let t=window.devicePixelRatio,e=this.canvas.getBoundingClientRect();this.canvas.width=e.width*t,this.canvas.height=e.height*t,this.useOffScreen&&(this.offScreen||(this.offScreen=document.createElement("canvas")),this.offScreen.width=e.width*t,this.offScreen.height=e.height*t);let s=this.canvas.getContext("2d");s&&(s.scale(t,t),!(this.offScreen&&!this.offScreen.getContext("2d"))&&this.draw())}draw(t,e,s=this.zoom){if(!this.canvas||this.useOffScreen&&!this.offScreen)return;let n=this.canvas.getBoundingClientRect(),i=h.getTilePixelByZoom(s),o=h.degrees2meters(this.center.lat,this.center.lng),r=h.meters2tile(o.x,o.y,s),u=h.getMetersPerPixelByZoom(s),m=o.x-(t!=null?t:n.width/2)*u,L=o.y+(e!=null?e:n.height/2)*u,g=h.meters2tile(m,L,s),p=h.tile2meters(r.x,r.y,s),y=h.meter2world(p.x,p.y,s),w=h.meter2world(o.x,o.y,s),E=t!=null?t:n.width/2,I=e!=null?e:n.height/2,T=w.x-y.x,N=w.y-y.y,C=(E-T)%i,Z=Math.ceil((n.width-C)/i)+(C>0?1:0),D=(I-N)%i,j=Math.ceil((n.height-D)/i)+(D>0?1:0),R=this.canvas.getContext("2d");if(!R)return;let l=this.offScreen?this.offScreen.getContext("2d"):R;if(l)this.debug&&(l.lineWidth=1,l.strokeStyle="#f00",l.fillStyle="red",l.textAlign="center",l.textBaseline="middle",l.font="26px Arial");else return;let z=h.tile2meters(g.x,g.y,s),G=z.x-m,k=L-z.y,H=G/u,W=k/u,$=Z*j,O=0;for(let d of this.images)d.src="";this.images=[];for(let d=0;d<Z;d++)for(let f=0;f<j;f++){let S=g.x+d,B=g.y+f,A=this.getMapURL(S,B,s),b=new Image;this.images.push(b),b.addEventListener("load",()=>{let x=d*i+H,M=f*i+W;this.offScreen?(l.drawImage(b,x,M,i,i),this.debug&&(l.strokeRect(x,M,i,i),l.fillText(`${s}/${S}/${B}`,x+i/2,M+i/2)),O++,O===$&&R.drawImage(this.offScreen,0,0)):(l.drawImage(b,x,M,i,i),this.debug&&(l.strokeRect(x,M,i,i),l.fillText(`${s}/${S}/${B}`,x+i/2,M+i/2)))}),b.src=A}if(this.zoom=s,t!==void 0&&e!==void 0){let d=n.width/2-t,f=n.height/2-e;this.moveCenter(d,f)}}getMapURL(t,e,s){let n=Math.round(s),i=1<<n;return t=t%i,t<0&&(t=i+t),e=e%i,e<0&&(e=i+e),this.mapSource.replace("{x}",String(t)).replace("{y}",String(e)).replace("{z}",String(n))}setGPXData(t,e=!1){!t||isNaN(t.stats.center.lat)||isNaN(t.stats.center.lng)||(this.gpxData=t,e&&(this.adjustCenterByGPXData(),this.adjustZoomLevelByGPXData()))}adjustCenterByGPXData(){if(this.gpxData&&this.gpxData.stats){let t=this.gpxData.stats;this.latMax=t.latMax,this.lngMin=t.lngMin,this.setView(t.center)}}adjustZoomLevelByGPXData(t=1.2){if(!this.canvas||!this.gpxData)return;let e=this.canvas.getBoundingClientRect(),s=this.gpxData.stats,n=h.degrees2meters(s.latMin,s.lngMin),i=h.degrees2meters(s.latMax,s.lngMax),o=(i.x-n.x)*t,r=(i.y-n.y)*t,u=Math.round(h.getZoomByMetersPerPixel(o/e.width)),m=Math.round(h.getZoomByMetersPerPixel(r/e.height));this.zoom=u<m?u:m}setMapSource(t){this.mapSource=t}setView(t,e){this.center=new v(t),this.setZoom(e)}setZoom(t){t&&t>0&&t<30&&(this.zoom=t)}moveCenter(t,e){let s=h.getMetersPerPixelByZoom(this.zoom),n=h.degrees2meters(this.center.lat,this.center.lng);n.x+=t*s,n.y-=e*s;let i=h.meters2degrees(n.x,n.y);i.lat>85&&(i.lat=85),i.lat<-85&&(i.lat=-85),i.lng>180&&(i.lng-=360),i.lng<-180&&(i.lng+=360),this.center.lat=i.lat,this.center.lng=i.lng}start({offsetX:t,offsetY:e}){this.isMoving=!0,this.oldPoint={x:t,y:e}}stop(){this.oldPoint=void 0,this.isMoving=!1}move({offsetX:t,offsetY:e}){if(this.oldPoint){let s=this.oldPoint.x-t,n=this.oldPoint.y-e;this.moveCenter(s,n)}this.oldPoint={x:t,y:e}}handlerResize(){return()=>{this.resize()}}handlerMouseDown(){return t=>{this.canvas&&(this.canvas.style.cursor="grab"),this.start(t)}}handlerMouseUp(){return()=>{this.stop(),this.canvas&&(this.canvas.style.cursor="")}}handlerMouseMove(){return t=>{this.isMoving&&(this.canvas&&(this.canvas.style.cursor="grabbing"),this.move(t),this.draw())}}handlerMouseLeave(){return()=>{}}handlerTouchStart(){return t=>{if(!this.canvas)return;t.preventDefault();let e=this.canvas.getBoundingClientRect(),s=this.touchMap,n=Object.keys(s).length;for(let i=0;i<t.changedTouches.length;i++){let o=t.changedTouches[i],r={id:o.identifier,x:o.pageX-e.left,y:o.pageY-e.top};s[o.identifier]=r}this.touchList=Object.values(s).sort((i,o)=>i.id-o.id),n===0&&this.start({offsetX:this.touchList[0].x,offsetY:this.touchList[0].y})}}handlerTouchEnd(){return t=>{if(!this.canvas)return;let e=this.touchMap;for(let s=0;s<t.changedTouches.length;s++){let n=t.changedTouches[s];this.touchList.length>0&&this.touchList[0].id===n.identifier&&this.stop(),delete e[n.identifier]}this.touchList=Object.values(e).sort((s,n)=>s.id-n.id),!this.isMoving&&this.touchList.length>0&&this.start({offsetX:this.touchList[0].x,offsetY:this.touchList[0].y})}}handlerTouchMove(){return t=>{if(!this.canvas)return;let e=this.canvas.getBoundingClientRect(),s=this.touchMap;for(let i=0;i<t.changedTouches.length;i++){let o=t.changedTouches[i],r=s[o.identifier];r?(r.old={x:r.x,y:r.y},r.x=o.pageX-e.left,r.y=o.pageY-e.top):(r={id:o.identifier,x:o.pageX-e.left,y:o.pageY-e.top},s[o.identifier]=r)}this.touchList=Object.values(s).sort((i,o)=>i.id-o.id);let n=this.touchList[0];if(n.old){let i=n.old.x-n.x,o=n.old.y-n.y;if(this.touchList.length>=2){let r=this.touchList[1];if(r.old){let u=r.old.x-r.x,m=r.old.y-r.y,L=(i+u)/2,g=(o+m)/2,p=(n.x+r.x)/2,y=(n.y+r.y)/2;this.moveCenter(p-e.width/2+L,y-e.height/2+g);let w=Math.sqrt((n.old.x-r.old.x)**2+(n.old.y-r.old.y)**2),E=Math.sqrt((n.x-r.x)**2+(n.y-r.y)**2),I=h.getMetersPerPixelByZoom(this.zoom),T=h.getZoomByMetersPerPixel(I*w/E);this.draw(p,y,T);return}}}this.move({offsetX:n.x,offsetY:n.y}),this.draw()}}handlerMouseWheel(){return t=>{if(!this.canvas)return;t.preventDefault();let e=t.offsetX,s=t.offsetY,n=this.canvas.getBoundingClientRect(),i=e-n.width/2,o=s-n.height/2;this.moveCenter(i,o);let r=this.zoom;if(t.deltaY<0)r+=.1,r>this.zoomMax&&(r=this.zoomMax);else if(t.deltaY>0)r+=-.1,r<this.zoomMin&&(r=this.zoomMin);else return;this.draw(e,s,r)}}};window&&(window.Mapricorn=c=>new P(c));})();
//# sourceMappingURL=mapricorn.min.js.map
