"use strict";(()=>{var rt=Object.defineProperty;var ot=(c,t,n)=>t in c?rt(c,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):c[t]=n;var l=(c,t,n)=>(ot(c,typeof t!="symbol"?t+"":t,n),n);function it(c,t){let n=Math.pow(10,t===void 0?6:t);return Math.round(c*n)/n}var K=class c{constructor(t,n,e){l(this,"lat",0);l(this,"lng",0);l(this,"alt");if(t instanceof c)return t;if(Array.isArray(t)&&typeof t[0]!="object"){if(t.length===3)return new c(t[0],t[1],t[2]);if(t.length===2)return new c(t[0],t[1]);throw new Error("Invalid parameters")}if(t==null)return t;if(typeof t=="object"&&"lat"in t)return new c(t.lat,t.lng,t.alt);if(n===void 0)throw new Error("Invalid parameters");let i=t;if(isNaN(i)||isNaN(n))throw new Error("Invalid LatLng object: ("+i+", "+n+")");this.lat=i,this.lng=n,e!==void 0&&(this.alt=e)}equals(t,n){if(!t)return!1;let e=new c(t);return Math.max(Math.abs(this.lat-e.lat),Math.abs(this.lng-e.lng))<=(n===void 0?1e-9:n)}toString(t){return"LatLng("+it(this.lat,t)+", "+it(this.lng,t)+")"}clone(){return new c(this.lat,this.lng,this.alt)}};var a=class c{static getTilePixelByZoom(t){return 256*(2**t/2**Math.round(t))}static degrees2meters(t,n){let e=n*6378137*Math.PI/180,i=6378137*Math.log(Math.tan(Math.PI/4+t*Math.PI/180/2));return{x:e,y:i}}static meters2degrees(t,n){let e=(2*Math.atan(Math.exp(n/6378137))-Math.PI/2)/Math.PI*180,i=t/6378137/Math.PI*180;return{lat:e,lng:i}}static meters2tile(t,n,e){let i=Math.floor((t+6378137*Math.PI)/(12756274*Math.PI)*2**Math.round(e)),o=Math.floor((1-(n+6378137*Math.PI)/(2*6378137*Math.PI))*2**Math.round(e));return{x:i,y:o}}static degrees2tile(t,n,e){let i=c.degrees2meters(t,n);return c.meters2tile(i.x,i.y,e)}static tile2meters(t,n,e){let i=t/2**Math.round(e)*(12756274*Math.PI)-6378137*Math.PI,o=(1-n/2**Math.round(e))*(2*6378137*Math.PI)-6378137*Math.PI;return{x:i,y:o}}static meter2world(t,n,e){let i=this.getMetersPerPixelByZoom(e),o=t/i,r=-n/i;return{x:o,y:r}}static getZoomByMetersPerPixel(t){return Math.log(2*Math.PI*6378137/(t*256))/Math.log(2)}static getMetersPerTileByZoom(t){return 2*Math.PI*6378137/2**t}static getMetersPerPixelByZoom(t){return 2*6378137*Math.PI/(2**t*256)}};var m=class c{constructor(t,n){l(this,"x");l(this,"y");this.x=t,this.y=n}clone(){return new c(this.x,this.y)}add(t){return t instanceof c?(this.x+=t.x,this.y+=t.y):(this.x+=t,this.y+=t),this}sub(t){return t instanceof c?(this.x-=t.x,this.y-=t.y):(this.x-=t,this.y-=t),this}mul(t){return this.x*=t,this.y*=t,this}div(t){return this.x/=t,this.y/=t,this}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}lengthSq(){return this.x**2+this.y**2}angleTo(t){let n=Math.sqrt(this.lengthSq()*t.lengthSq());if(n===0)throw new Error("angleTo() can't handle zero length vectors.");let e=this.dot(t)/n;return e<-1&&(e=-1),e>1&&(e=1),Math.acos(e)}translate(t,n){return this.x+=t,this.y+=n,this}rotate(t){let n=Math.cos(t)*this.x-Math.sin(t)*this.y,e=Math.sin(t)*this.x+Math.cos(t)*this.y;return this.x=n,this.y=e,this}};var Q=class{constructor(t){l(this,"debug",!1);l(this,"container");l(this,"width","");l(this,"height","");l(this,"canvas");l(this,"mapSource","https://tile.openstreetmap.org/{z}/{x}/{y}.png");l(this,"gpxData");l(this,"center");l(this,"zoom",2);l(this,"zoomMax",19);l(this,"zoomMin",2);l(this,"latMax",0);l(this,"lngMin",0);l(this,"enableRotate",!0);l(this,"_oldPoint");l(this,"_isMoving",!1);l(this,"_imageCache",{});l(this,"_drawing",!1);l(this,"_pointers",{});l(this,"_shiftL",!1);l(this,"_theta",0);this.center=new K([0,0,0]),this.canvas=document.createElement("canvas"),t&&(t.mapSource&&(this.mapSource=t.mapSource),t.center&&(this.center=new K(t.center)),t.zoom&&this.setZoom(t.zoom),t.width&&(this.width=t.width),t.height&&(this.height=t.height),t.enableRotate&&(this.enableRotate=t.enableRotate),t.container&&this.bind(t.container))}bind(t){if(t===void 0)throw new Error("Invalid container");this.container=t,this.setup(),this.resize()}setup(){this.container&&(this.container.style.position="relative",this.width&&(this.container.style.width=this.width),this.height&&(this.container.style.height=this.height),this.canvas=document.createElement("canvas"),this.canvas.tabIndex=0,this.canvas.style.outline="none",this.canvas.focus(),this.canvas.style.position="absolute",this.canvas.style.width="100%",this.canvas.style.height="100%",this.container.appendChild(this.canvas),this.canvas.addEventListener("touchstart",t=>{t.preventDefault()}),this.canvas.addEventListener("pointerdown",this.handlerPointerDown()),this.canvas.addEventListener("pointerup",this.handlerPointerUp()),this.canvas.addEventListener("pointermove",this.handlerPointerMove()),this.canvas.addEventListener("wheel",this.handlerMouseWheel()),this.canvas.addEventListener("keydown",this.handlerKeyDown()),this.canvas.addEventListener("keyup",this.handlerKeyUp()),window.addEventListener("resize",this.handlerResize()))}resize(){let t=window.devicePixelRatio;this.canvas.width=this.canvas.clientWidth*t,this.canvas.height=this.canvas.clientHeight*t;let n=this.canvas.getContext("2d");n&&(n.restore(),n.scale(t,t),n.save(),this.draw())}draw(t,n,e=this.zoom,i=!0){let o=(s,h,p)=>{let d=-1,b={id:0},v=f=>{d<0&&(d=f);let T=(f-d)/h;s(T),T<1?b.id=requestAnimationFrame(v):p()};return b.id=requestAnimationFrame(v),b},r=()=>{if(this.zoom=e,this._drawing=!1,t!==void 0&&n!==void 0){let s=this.canvas.clientWidth/2-t,h=this.canvas.clientHeight/2-n;this.moveCenter(s,h)}};if(!this._drawing)if(this._drawing=!0,!i||e==this.zoom)this.draw2d(this.canvas,this.center,e,1,t,n),r();else{let s=e>this.zoom?1:-1;o(h=>{h>1&&(h=1),this.draw2d(this.canvas,this.center,this.zoom+s*h,1,t,n)},300,r)}}draw2d(t,n,e,i=1,o,r){let s=t.clientWidth,h=t.clientHeight,p=o!=null?o:s/2,d=r!=null?r:h/2,b=new m(-p,-d).rotate(-this._theta),v=new m(s-p,-d).rotate(-this._theta),f=new m(s-p,h-d).rotate(-this._theta),T=new m(-p,h-d).rotate(-this._theta),y=a.degrees2meters(n.lat,n.lng),w=a.getMetersPerPixelByZoom(e),P=new m(y.x+b.x*w,y.y-b.y*w),L=new m(y.x+v.x*w,y.y-v.y*w),I=new m(y.x+f.x*w,y.y-f.y*w),_=new m(y.x+T.x*w,y.y-T.y*w),W=L.clone().sub(P),z=I.clone().sub(L),N=_.clone().sub(I),$=P.clone().sub(_),x=a.meters2tile(P.x,P.y,e),E=a.meters2tile(L.x,L.y,e),tt=a.meters2tile(I.x,I.y,e),et=a.meters2tile(_.x,_.y,e),X=1/0,A=1/0,H=-1/0,Z=-1/0;[x,E,tt,et].forEach(u=>{u.x<X&&(X=u.x),u.y<A&&(A=u.y),u.x>H&&(H=u.x),u.y>Z&&(Z=u.y)});let g=t.getContext("2d");if(!g)return;g.restore(),g.save(),g.globalAlpha=i,g.translate(p,d),g.rotate(this._theta),this.debug&&(g.lineWidth=1,g.strokeStyle="#f00",g.fillStyle="red",g.textAlign="center",g.textBaseline="middle",g.font="26px Arial");let Y=a.meter2world(y.x,y.y,e),B=a.meters2tile(y.x,y.y,e),k=a.tile2meters(B.x,B.y,e),q=a.meter2world(k.x,k.y,e),C=Y.x-q.x,J=Y.y-q.y,R=a.getTilePixelByZoom(e),nt=H-X+1,st=Z-A+1,j=[...Array(st)].map(()=>[...Array(nt)].fill(!1));for(let u=0;u<st;u++)for(let M=0;M<nt;M++){let G=a.tile2meters(M+X,u+A,e),D=new m(G.x,G.y),O=D.clone().sub(P),U=D.clone().sub(L),V=D.clone().sub(I),S=D.clone().sub(_),F=W.cross(O)<0&&z.cross(U)<0&&N.cross(V)<0&&$.cross(S)<0;j[u][M]=F,F&&(u>0&&(j[u-1][M]=!0),M>0&&(j[u][M-1]=!0),u>0&&M>0&&(j[u-1][M-1]=!0))}for(let u=0;u<st;u++)for(let M=0;M<nt;M++)if(j[u][M]){let G=X+M,D=A+u,O=(G-B.x)*R-C,U=(D-B.y)*R-J,V=this.getMapURL(G,D,e),S;V in this._imageCache?(S=this._imageCache[V],g.drawImage(S,O,U,R,R)):(S=new Image(R,R),S.src=V);let F=()=>{g.drawImage(S,O,U,R,R),S.removeEventListener("load",F),this._imageCache[V]=S,this.debug&&(g.strokeRect(O,U,R,R),g.fillText(`${e}/${G}/${D}`,O+R/2,U+R/2))};S.addEventListener("load",F)}}draw2d_(t,n,e,i=1,o,r){let s=a.getTilePixelByZoom(e),h=a.degrees2meters(n.lat,n.lng),p=a.meters2tile(h.x,h.y,e),d=o!=null?o:t.clientWidth/2,b=r!=null?r:t.clientHeight/2,v=a.getMetersPerPixelByZoom(e),f=h.x-d*v,T=h.y+b*v,y=a.meters2tile(f,T,e),w=a.tile2meters(p.x,p.y,e),P=a.meter2world(w.x,w.y,e),L=a.meter2world(h.x,h.y,e),I=L.x-P.x,_=L.y-P.y,W=(d-I)%s,z=Math.ceil((t.clientWidth-W)/s)+(W>0?1:0),N=(b-_)%s,$=Math.ceil((t.clientHeight-N)/s)+(N>0?1:0),x=t.getContext("2d");if(!x)return;x.restore(),x.save(),x.globalAlpha=i,x.translate(d,b),x.rotate(this._theta),this.debug&&(x.lineWidth=1,x.strokeStyle="#f00",x.fillStyle="red",x.textAlign="center",x.textBaseline="middle",x.font="26px Arial");let E=a.tile2meters(y.x,y.y,e),tt=E.x-f,et=T-E.y,X=tt/v,A=et/v;for(let H=0;H<z;H++)for(let Z=0;Z<$;Z++){let g=y.x+H,Y=y.y+Z,B=H*s+X-d,k=Z*s+A-b,q=this.getMapURL(g,Y,e),C;q in this._imageCache?(C=this._imageCache[q],x.drawImage(C,B,k,s,s)):(C=new Image(s,s),C.src=q);let J=()=>{x.drawImage(C,B,k,s,s),C.removeEventListener("load",J),this._imageCache[q]=C,this.debug&&(x.strokeRect(B,k,s,s),x.fillText(`${e}/${g}/${Y}`,B+s/2,k+s/2))};C.addEventListener("load",J)}}getMapURL(t,n,e){let i=Math.round(e),o=1<<i;return t=t%o,t<0&&(t=o+t),n=n%o,n<0&&(n=o+n),this.mapSource.replace("{x}",String(t)).replace("{y}",String(n)).replace("{z}",String(i))}setGPXData(t,n=!1){!t||isNaN(t.stats.center.lat)||isNaN(t.stats.center.lng)||(this.gpxData=t,n&&(this.adjustCenterByGPXData(),this.adjustZoomLevelByGPXData()))}adjustCenterByGPXData(){if(this.gpxData&&this.gpxData.stats){let t=this.gpxData.stats;this.latMax=t.latMax,this.lngMin=t.lngMin,this.setView(t.center)}}adjustZoomLevelByGPXData(t=1.2){if(!this.gpxData)return;let n=this.gpxData.stats,e=a.degrees2meters(n.latMin,n.lngMin),i=a.degrees2meters(n.latMax,n.lngMax),o=(i.x-e.x)*t,r=(i.y-e.y)*t,s=Math.round(a.getZoomByMetersPerPixel(o/this.canvas.clientWidth)),h=Math.round(a.getZoomByMetersPerPixel(r/this.canvas.clientHeight));this.zoom=s<h?s:h}setMapSource(t){this.mapSource=t}setView(t,n){this.center=new K(t),this.setZoom(n)}setZoom(t){t&&t>0&&t<30&&(this.zoom=t)}moveCenter(t,n){let e=new m(t,n);if(e.rotate(-this._theta),this._drawing)return;let i=a.getMetersPerPixelByZoom(this.zoom),o=a.degrees2meters(this.center.lat,this.center.lng);o.x+=e.x*i,o.y-=e.y*i;let r=a.meters2degrees(o.x,o.y);r.lat>85&&(r.lat=85),r.lat<-85&&(r.lat=-85),r.lng>180&&(r.lng-=360),r.lng<-180&&(r.lng+=360),this.center.lat=r.lat,this.center.lng=r.lng}start({offsetX:t,offsetY:n}){this._isMoving=!0,this._oldPoint={x:t,y:n}}stop(){this._oldPoint=void 0,this._isMoving=!1}move({offsetX:t,offsetY:n}){if(this._oldPoint){let e=this._oldPoint.x-t,i=this._oldPoint.y-n;this.moveCenter(e,i)}this._oldPoint={x:t,y:n}}handlerResize(){return()=>{this.resize()}}handlerPointerDown(){return t=>{this._pointers[t.pointerId]={id:t.pointerId,x:t.offsetX,y:t.offsetY},t.currentTarget.setPointerCapture(t.pointerId);let e=Object.values(this._pointers);e.length===1&&(this.canvas.style.cursor="grab",this.start({offsetX:e[0].x,offsetY:e[0].y}))}}handlerPointerUp(){return t=>{t.currentTarget.releasePointerCapture(t.pointerId),delete this._pointers[t.pointerId],Object.values(this._pointers).length===0&&(this.stop(),this.canvas.style.cursor="")}}handlerPointerMove(){return t=>{if(!this._isMoving)return;if(t.pointerId in this._pointers){let s=this._pointers[t.pointerId];s.old={x:s.x,y:s.y},s.x=t.offsetX,s.y=t.offsetY}else this._pointers[t.pointerId]={id:t.pointerId,x:t.offsetX,y:t.offsetY};let n=Object.values(this._pointers).sort((s,h)=>s.id-h.id);if(n.length===0)return;let e=n[0];if(!e.old)return;let i=this.canvas.clientWidth,o=this.canvas.clientHeight,r=new m(e.old.x-e.x,e.old.y-e.y);if(n.length>=2){let s=n[1];if(!s.old)return;let h=new m(s.old.x-s.x,s.old.y-s.y),p=(r.x+h.x)/2,d=(r.y+h.y)/2,b=(e.x+s.x)/2,v=(e.y+s.y)/2;this.moveCenter(b-i/2+p,v-o/2+d);let f=this.zoom,T=Math.sqrt((e.old.x-s.old.x)**2+(e.old.y-s.old.y)**2),y=Math.sqrt((e.x-s.x)**2+(e.y-s.y)**2),w=a.getMetersPerPixelByZoom(this.zoom);if(f=a.getZoomByMetersPerPixel(w*T/y),f>this.zoomMax&&(f=this.zoomMax),f<this.zoomMin&&(f=this.zoomMin),this.enableRotate&&n.length>=3){let P=new m(e.old.x/i-.5,e.old.y/o-.5),L=new m(e.x/i-.5,e.y/o-.5),I=new m(s.old.x/i-.5,s.old.y/o-.5),_=new m(s.x/i-.5,s.y/o-.5),W=P.clone().add(I).div(2),z=L.clone().add(_).div(2);P.sub(W),I.sub(W),L.sub(z),_.sub(z);let N=P.angleTo(L)*(P.cross(L)<0?-1:1),$=I.angleTo(_)*(I.cross(_)<0?-1:1),x=(N+$)/2,E=this._theta+x;E>Math.PI*2&&(E=E-Math.PI*2),E<-Math.PI*2&&(E=E+Math.PI*2),this._theta=E}this.draw(b,v,f,!1);return}else{if(this.enableRotate&&this._shiftL){let s=new m(e.old.x/i-.5,e.old.y/o-.5),h=new m(e.x/i-.5,e.y/o-.5),p=s.cross(h)<0?-1:1,d=this._theta+s.angleTo(h)*p;d>Math.PI*2&&(d=d-Math.PI*2),d<-Math.PI*2&&(d=d+Math.PI*2),this._theta=d,this.draw()}else if(this._oldPoint){let s=this._oldPoint.x-r.x,h=this._oldPoint.y-r.y;this.move({offsetX:s,offsetY:h}),this.draw()}return}}}handlerMouseWheel(){return t=>{t.preventDefault();let n=t.offsetX,e=t.offsetY,i=t.offsetX-this.canvas.clientWidth/2,o=t.offsetY-this.canvas.clientHeight/2;this.moveCenter(i,o);let r=this.zoom;if(t.deltaY<0)r+=1,r>this.zoomMax&&(r=this.zoomMax);else if(t.deltaY>0)r+=-1,r<this.zoomMin&&(r=this.zoomMin);else return;this.draw(n,e,r)}}handlerKeyDown(){let t={ShiftLeft:()=>{this._shiftL=!0}};return n=>{let e=t[n.code];e&&e()}}handlerKeyUp(){let t={ShiftLeft:()=>{this._shiftL=!1}};return n=>{let e=t[n.code];e&&e()}}};window&&(window.Mapricorn=c=>new Q(c));})();
//# sourceMappingURL=mapricorn.min.js.map
