"use strict";(()=>{var ht=Object.defineProperty;var ct=(c,t,n)=>t in c?ht(c,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):c[t]=n;var a=(c,t,n)=>(ct(c,typeof t!="symbol"?t+"":t,n),n);function st(c,t){let n=Math.pow(10,t===void 0?6:t);return Math.round(c*n)/n}var H=class c{constructor(t,n,e){a(this,"lat",0);a(this,"lng",0);a(this,"alt");if(t instanceof c)return t;if(Array.isArray(t)&&typeof t[0]!="object"){if(t.length===3)return new c(t[0],t[1],t[2]);if(t.length===2)return new c(t[0],t[1]);throw new Error("Invalid parameters")}if(t==null)return t;if(typeof t=="object"&&"lat"in t)return new c(t.lat,t.lng,t.alt);if(n===void 0)throw new Error("Invalid parameters");let s=t;if(isNaN(s)||isNaN(n))throw new Error("Invalid LatLng object: ("+s+", "+n+")");this.lat=s,this.lng=n,e!==void 0&&(this.alt=e)}equals(t,n){if(!t)return!1;let e=new c(t);return Math.max(Math.abs(this.lat-e.lat),Math.abs(this.lng-e.lng))<=(n===void 0?1e-9:n)}toString(t){return"LatLng("+st(this.lat,t)+", "+st(this.lng,t)+")"}clone(){return new c(this.lat,this.lng,this.alt)}};var d=class c{static getTilePixelByZoom(t,n=0){return 256*(2**(t+n)/2**Math.round(t))}static degrees2meters(t,n){let e=n*6378137*Math.PI/180,s=6378137*Math.log(Math.tan(Math.PI/4+t*Math.PI/180/2));return{x:e,y:s}}static meters2degrees(t,n){let e=(2*Math.atan(Math.exp(n/6378137))-Math.PI/2)/Math.PI*180,s=t/6378137/Math.PI*180;return{lat:e,lng:s}}static meters2tile(t,n,e){let s=Math.floor((t+6378137*Math.PI)/(12756274*Math.PI)*2**Math.round(e)),o=Math.floor((1-(n+6378137*Math.PI)/(2*6378137*Math.PI))*2**Math.round(e));return{x:s,y:o}}static degrees2tile(t,n,e){let s=c.degrees2meters(t,n);return c.meters2tile(s.x,s.y,e)}static tile2meters(t,n,e){let s=t/2**Math.round(e)*(12756274*Math.PI)-6378137*Math.PI,o=(1-n/2**Math.round(e))*(2*6378137*Math.PI)-6378137*Math.PI;return{x:s,y:o}}static meter2world(t,n,e){let s=this.getMetersPerPixelByZoom(e),o=t/s,r=-n/s;return{x:o,y:r}}static getZoomByMetersPerPixel(t){return Math.log(2*Math.PI*6378137/(t*256))/Math.log(2)}static getMetersPerTileByZoom(t){return 2*Math.PI*6378137/2**t}static getMetersPerPixelByZoom(t){return 2*6378137*Math.PI/(2**t*256)}};var u=class c{constructor(t,n){a(this,"x");a(this,"y");this.x=t,this.y=n}clone(){return new c(this.x,this.y)}add(t){return t instanceof c?(this.x+=t.x,this.y+=t.y):(this.x+=t,this.y+=t),this}sub(t){return t instanceof c?(this.x-=t.x,this.y-=t.y):(this.x-=t,this.y-=t),this}mul(t){return this.x*=t,this.y*=t,this}div(t){return this.x/=t,this.y/=t,this}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}lengthSq(){return this.x**2+this.y**2}angleTo(t){let n=Math.sqrt(this.lengthSq()*t.lengthSq());if(n===0)throw new Error("angleTo() can't handle zero length vectors.");let e=this.dot(t)/n;return e<-1&&(e=-1),e>1&&(e=1),Math.acos(e)}translate(t,n){return this.x+=t,this.y+=n,this}rotate(t){let n=Math.cos(t)*this.x-Math.sin(t)*this.y,e=Math.sin(t)*this.x+Math.cos(t)*this.y;return this.x=n,this.y=e,this}};var k=class{constructor(t){a(this,"container");a(this,"width","");a(this,"height","");a(this,"canvas");a(this,"canvas2");a(this,"mapSource","https://tile.openstreetmap.org/{z}/{x}/{y}.png");a(this,"gpxData");a(this,"center");a(this,"zoom",2);a(this,"zoomMax",19);a(this,"zoomMin",2);a(this,"latMax",0);a(this,"lngMin",0);a(this,"enableRotate",!0);a(this,"showTileInfo",!1);a(this,"_serial",0);a(this,"_oldPoint");a(this,"_isMoving",!1);a(this,"_imageCache");a(this,"_drawing",!1);a(this,"_pointers");a(this,"_shiftL",!1);a(this,"_theta",0);this.center=new H([0,0,0]),this.canvas=document.createElement("canvas"),this.canvas2=document.createElement("canvas"),this._imageCache={},this._pointers={},t&&(t.mapSource&&(this.mapSource=t.mapSource),t.center&&(this.center=new H(t.center)),t.zoom&&this.setZoom(t.zoom),t.width&&(this.width=t.width),t.height&&(this.height=t.height),t.enableRotate&&(this.enableRotate=t.enableRotate),t.showTileInfo&&(this.showTileInfo=t.showTileInfo),t.container&&this.bind(t.container))}bind(t){if(t===void 0)throw new Error("Invalid container");this.container=t,this.setup(),this.resize()}setup(){this.container&&(this.container.style.position="relative",this.container.style.overflow="hidden",this.width&&(this.container.style.width=this.width),this.height&&(this.container.style.height=this.height),this.canvas=document.createElement("canvas"),this.canvas.style.position="absolute",this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.zIndex="1",this.container.appendChild(this.canvas),this.canvas2=document.createElement("canvas"),this.canvas2.style.position="absolute",this.canvas2.style.width="100%",this.canvas2.style.height="100%",this.canvas2.style.zIndex="0",this.container.appendChild(this.canvas2),window.addEventListener("resize",this.handlerResize()),this.container.tabIndex=0,this.container.style.outline="none",this.container.focus(),this.container.addEventListener("touchstart",t=>{t.preventDefault()}),this.container.addEventListener("pointerdown",this.handlerPointerDown()),this.container.addEventListener("pointerup",this.handlerPointerUp()),this.container.addEventListener("pointermove",this.handlerPointerMove()),this.container.addEventListener("wheel",this.handlerMouseWheel()),this.container.addEventListener("keydown",this.handlerKeyDown()),this.container.addEventListener("keyup",this.handlerKeyUp()))}resize(){let t=window.devicePixelRatio;this.canvas.width=this.canvas.clientWidth*t,this.canvas.height=this.canvas.clientHeight*t,this.canvas2.width=this.canvas2.clientWidth*t,this.canvas2.height=this.canvas2.clientHeight*t;let n=this.canvas.getContext("2d");if(!n)return;n.restore(),n.scale(t,t),n.save();let e=this.canvas2.getContext("2d");e&&(e.restore(),e.scale(t,t),e.save(),this.draw())}draw(t,n,e=this.zoom,s=!0){let o=(i,l,b)=>{let m=-1,E={id:0},R=p=>{m<0&&(m=p);let _=(p-m)/l;_>1&&(_=1),i(_),_<1?E.id=requestAnimationFrame(R):b()};return E.id=requestAnimationFrame(R),E},r=()=>{if(s&&e!=this.zoom&&this.draw2d(this.canvas,this.center,e,0,t,n),this.canvas.style.opacity="1.0",this.zoom=e,this._drawing=!1,t!==void 0&&n!==void 0){let i=this.canvas.clientWidth/2-t,l=this.canvas.clientHeight/2-n;this.moveCenter(i,l)}};if(!this._drawing)if(this._drawing=!0,!s||e==this.zoom)this.draw2d(this.canvas,this.center,e,0,t,n),r();else{let i=e-this.zoom;o(l=>{this.canvas.style.opacity=String(1-l),this.draw2d(this.canvas,this.center,this.zoom,i*l,t,n),this.draw2d(this.canvas2,this.center,e,-i*(1-l),t,n)},300,r)}}draw2d(t,n,e,s=0,o,r){let i=t.clientWidth,l=t.clientHeight,b=o!=null?o:i/2,m=r!=null?r:l/2,E=new u(-b,-m).rotate(-this._theta),R=new u(i-b,-m).rotate(-this._theta),p=new u(i-b,l-m).rotate(-this._theta),_=new u(-b,l-m).rotate(-this._theta),y=d.degrees2meters(n.lat,n.lng),M=d.getMetersPerPixelByZoom(e+s),w=new u(y.x+E.x*M,y.y-E.y*M),P=new u(y.x+R.x*M,y.y-R.y*M),L=new u(y.x+p.x*M,y.y-p.y*M),I=new u(y.x+_.x*M,y.y-_.y*M),q=P.clone().sub(w),N=L.clone().sub(P),V=I.clone().sub(L),K=w.clone().sub(I),U=d.meters2tile(w.x,w.y,e),T=d.meters2tile(P.x,P.y,e),it=d.meters2tile(L.x,L.y,e),rt=d.meters2tile(I.x,I.y,e),Z=1/0,X=1/0,Y=-1/0,$=-1/0;[U,T,it,rt].forEach(h=>{h.x<Z&&(Z=h.x),h.y<X&&(X=h.y),h.x>Y&&(Y=h.x),h.y>$&&($=h.y)});let J=d.meter2world(y.x,y.y,e+s),A=d.meters2tile(y.x,y.y,e),Q=d.tile2meters(A.x,A.y,e),tt=d.meter2world(Q.x,Q.y,e+s),ot=J.x-tt.x,at=J.y-tt.y,g=d.getTilePixelByZoom(e,s),x=t.getContext("2d");if(!x)return;x.restore(),x.save(),x.translate(b,m),x.rotate(this._theta);let et=(h,f,C)=>{x.strokeRect(h,f,g,g),x.fillText(C,h+g/2,f+g/2)};this.showTileInfo&&(x.lineWidth=1,x.strokeStyle="#f00",x.fillStyle="red",x.textAlign="center",x.textBaseline="middle",x.font=`${Math.ceil(g/10)}px Arial`);let j=Y-Z+1,F=$-X+1,W=[...Array(F)].map(()=>[...Array(j)].fill(!1));for(let h=0;h<F;h++)for(let f=0;f<j;f++){let C=d.tile2meters(f+Z,h+X,e),S=new u(C.x,C.y),z=S.clone().sub(w),D=S.clone().sub(P),O=S.clone().sub(L),B=S.clone().sub(I),v=q.cross(z)<0&&N.cross(D)<0&&V.cross(O)<0&&K.cross(B)<0;W[h][f]=v,v&&(h>0&&(W[h-1][f]=!0),f>0&&(W[h][f-1]=!0),h>0&&f>0&&(W[h-1][f-1]=!0))}let G=this._serial;for(let h=0;h<F;h++)for(let f=0;f<j;f++)if(W[h][f]){let C=Z+f,S=X+h,z=(C-A.x)*g-ot,D=(S-A.y)*g-at,O=`${Math.round(e)}/${C}/${S}`,B=this.getMapURL(C,S,e),v;B in this._imageCache?(v=this._imageCache[B],x.drawImage(v,z,D,g,g),this.showTileInfo&&et(z,D,O)):(v=new Image(g,g),v.src=B);let nt=()=>{G===this._serial&&(x.drawImage(v,z,D,g,g),this.showTileInfo&&et(z,D,O)),v.removeEventListener("load",nt),this._imageCache[B]=v};v.addEventListener("load",nt)}G++,this._serial=G>65536?0:G}getMapURL(t,n,e){let s=Math.round(e),o=1<<s;return t=t%o,t<0&&(t=o+t),n=n%o,n<0&&(n=o+n),this.mapSource.replace("{x}",String(t)).replace("{y}",String(n)).replace("{z}",String(s))}setGPXData(t,n=!1){!t||isNaN(t.stats.center.lat)||isNaN(t.stats.center.lng)||(this.gpxData=t,n&&(this.adjustCenterByGPXData(),this.adjustZoomLevelByGPXData()))}adjustCenterByGPXData(){if(this.gpxData&&this.gpxData.stats){let t=this.gpxData.stats;this.latMax=t.latMax,this.lngMin=t.lngMin,this.setView(t.center)}}adjustZoomLevelByGPXData(t=1.2){if(!this.gpxData)return;let n=this.gpxData.stats,e=d.degrees2meters(n.latMin,n.lngMin),s=d.degrees2meters(n.latMax,n.lngMax),o=(s.x-e.x)*t,r=(s.y-e.y)*t,i=Math.round(d.getZoomByMetersPerPixel(o/this.canvas.clientWidth)),l=Math.round(d.getZoomByMetersPerPixel(r/this.canvas.clientHeight));this.zoom=i<l?i:l}setMapSource(t){this.mapSource=t}setView(t,n){this.center=new H(t),this.setZoom(n)}setZoom(t){t&&t>0&&t<30&&(this.zoom=t)}moveCenter(t,n){if(this._drawing)return;let e=new u(t,n);e.rotate(-this._theta);let s=d.getMetersPerPixelByZoom(this.zoom),o=d.degrees2meters(this.center.lat,this.center.lng);o.x+=e.x*s,o.y-=e.y*s;let r=d.meters2degrees(o.x,o.y);r.lat>85&&(r.lat=85),r.lat<-85&&(r.lat=-85),r.lng>180&&(r.lng-=360),r.lng<-180&&(r.lng+=360),this.center.lat=r.lat,this.center.lng=r.lng}start({offsetX:t,offsetY:n}){this._isMoving=!0,this._oldPoint={x:t,y:n}}stop(){this._oldPoint=void 0,this._isMoving=!1}move({offsetX:t,offsetY:n}){if(this._oldPoint){let e=this._oldPoint.x-t,s=this._oldPoint.y-n;this.moveCenter(e,s)}this._oldPoint={x:t,y:n}}handlerResize(){return()=>{this.resize()}}handlerPointerDown(){return t=>{this._pointers[t.pointerId]={id:t.pointerId,x:t.offsetX,y:t.offsetY},t.currentTarget.setPointerCapture(t.pointerId);let e=Object.values(this._pointers);e.length===1&&(this.canvas.style.cursor="grab",this.start({offsetX:e[0].x,offsetY:e[0].y}))}}handlerPointerUp(){return t=>{t.currentTarget.releasePointerCapture(t.pointerId),delete this._pointers[t.pointerId],Object.values(this._pointers).length===0&&(this.stop(),this.canvas.style.cursor="")}}handlerPointerMove(){return t=>{if(!this._isMoving)return;if(t.pointerId in this._pointers){let i=this._pointers[t.pointerId];i.old={x:i.x,y:i.y},i.x=t.offsetX,i.y=t.offsetY}else this._pointers[t.pointerId]={id:t.pointerId,x:t.offsetX,y:t.offsetY};let n=Object.values(this._pointers).sort((i,l)=>i.id-l.id);if(n.length===0)return;let e=n[0];if(!e.old)return;let s=this.canvas.clientWidth,o=this.canvas.clientHeight,r=new u(e.old.x-e.x,e.old.y-e.y);if(n.length>=2){let i=n[1];if(!i.old)return;let l=new u(i.old.x-i.x,i.old.y-i.y),b=(r.x+l.x)/2,m=(r.y+l.y)/2,E=(e.x+i.x)/2,R=(e.y+i.y)/2;this.moveCenter(E-s/2+b,R-o/2+m);let p=this.zoom,_=Math.sqrt((e.old.x-i.old.x)**2+(e.old.y-i.old.y)**2),y=Math.sqrt((e.x-i.x)**2+(e.y-i.y)**2),M=d.getMetersPerPixelByZoom(this.zoom);if(p=d.getZoomByMetersPerPixel(M*_/y),p>this.zoomMax&&(p=this.zoomMax),p<this.zoomMin&&(p=this.zoomMin),this.enableRotate&&n.length>=3){let w=new u(e.old.x/s-.5,e.old.y/o-.5),P=new u(e.x/s-.5,e.y/o-.5),L=new u(i.old.x/s-.5,i.old.y/o-.5),I=new u(i.x/s-.5,i.y/o-.5),q=w.clone().add(L).div(2),N=P.clone().add(I).div(2);w.sub(q),L.sub(q),P.sub(N),I.sub(N);let V=w.angleTo(P)*(w.cross(P)<0?-1:1),K=L.angleTo(I)*(L.cross(I)<0?-1:1),U=(V+K)/2,T=this._theta+U;T>Math.PI*2&&(T=T-Math.PI*2),T<-Math.PI*2&&(T=T+Math.PI*2),this._theta=T}this.draw(E,R,p,!1);return}else{if(this.enableRotate&&this._shiftL){let i=new u(e.old.x/s-.5,e.old.y/o-.5),l=new u(e.x/s-.5,e.y/o-.5),b=i.cross(l)<0?-1:1,m=this._theta+i.angleTo(l)*b;m>Math.PI*2&&(m=m-Math.PI*2),m<-Math.PI*2&&(m=m+Math.PI*2),this._theta=m,this.draw()}else if(this._oldPoint){let i=this._oldPoint.x-r.x,l=this._oldPoint.y-r.y;this.move({offsetX:i,offsetY:l}),this.draw()}return}}}handlerMouseWheel(){return t=>{t.preventDefault();let n=t.offsetX,e=t.offsetY,s=t.offsetX-this.canvas.clientWidth/2,o=t.offsetY-this.canvas.clientHeight/2;this.moveCenter(s,o);let r=this.zoom;if(t.deltaY<0)r+=1,r>this.zoomMax&&(r=this.zoomMax);else if(t.deltaY>0)r+=-1,r<this.zoomMin&&(r=this.zoomMin);else return;this.draw(n,e,r)}}handlerKeyDown(){let t={ShiftLeft:()=>{this._shiftL=!0}};return n=>{let e=t[n.code];e&&e()}}handlerKeyUp(){let t={ShiftLeft:()=>{this._shiftL=!1}};return n=>{let e=t[n.code];e&&e()}}};window&&(window.Mapricorn=c=>new k(c));})();
//# sourceMappingURL=mapricorn.min.js.map
