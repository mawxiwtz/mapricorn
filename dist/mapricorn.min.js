"use strict";(()=>{var W=Object.defineProperty;var A=(c,t,e)=>t in c?W(c,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):c[t]=e;var a=(c,t,e)=>(A(c,typeof t!="symbol"?t+"":t,e),e);function X(c,t){let e=Math.pow(10,t===void 0?6:t);return Math.round(c*e)/e}var x=class c{constructor(t,e,i){a(this,"lat",0);a(this,"lng",0);a(this,"alt");if(t instanceof c)return t;if(Array.isArray(t)&&typeof t[0]!="object"){if(t.length===3)return new c(t[0],t[1],t[2]);if(t.length===2)return new c(t[0],t[1]);throw new Error("Invalid parameters")}if(t==null)return t;if(typeof t=="object"&&"lat"in t)return new c(t.lat,t.lng,t.alt);if(e===void 0)throw new Error("Invalid parameters");let s=t;if(isNaN(s)||isNaN(e))throw new Error("Invalid LatLng object: ("+s+", "+e+")");this.lat=s,this.lng=e,i!==void 0&&(this.alt=i)}equals(t,e){if(!t)return!1;let i=new c(t);return Math.max(Math.abs(this.lat-i.lat),Math.abs(this.lng-i.lng))<=(e===void 0?1e-9:e)}toString(t){return"LatLng("+X(this.lat,t)+", "+X(this.lng,t)+")"}clone(){return new c(this.lat,this.lng,this.alt)}};var h=class c{static getTilePixelByZoom(t){return 256*(2**t/2**Math.round(t))}static degrees2meters(t,e){let i=e*2003750834e-2/180,s=6378137*Math.log(Math.tan(Math.PI/4+t*Math.PI/180/2));return{x:i,y:s}}static meters2degrees(t,e){let i=(2*Math.atan(Math.exp(e/6378137))-Math.PI/2)/Math.PI*180,s=t/6378137/Math.PI*180;return{lat:i,lng:s}}static meters2tile(t,e,i){let s=Math.floor((t+6378137*Math.PI)/(12756274*Math.PI)*2**Math.round(i)),n=Math.floor((1-(e+6378137*Math.PI)/(2*6378137*Math.PI))*2**Math.round(i));return{x:s,y:n}}static degrees2tile(t,e,i){let s=c.degrees2meters(t,e);return c.meters2tile(s.x,s.y,i)}static tile2meters(t,e,i){let s=t/2**Math.round(i)*(12756274*Math.PI)-6378137*Math.PI,n=(1-e/2**Math.round(i))*(2*6378137*Math.PI)-6378137*Math.PI;return{x:s,y:n}}static meter2world(t,e,i){let s=this.getMetersPerPixelByZoom(i),n=t/s,o=-e/s;return{x:n,y:o}}static getZoomByMetersPerPixel(t){return Math.log(2*Math.PI*6378137/(t*256))/Math.log(2)}static getMetersPerTileByZoom(t){return 2*Math.PI*6378137/2**t}static getMetersPerPixelByZoom(t){return 2*6378137*Math.PI/(2**t*256)}};var P=class{constructor(t){a(this,"debug",!1);a(this,"container");a(this,"width","640px");a(this,"height","480px");a(this,"canvas");a(this,"mapSource","https://tile.openstreetmap.org/{z}/{x}/{y}.png");a(this,"offScreen");a(this,"useOffScreen",!1);a(this,"gpxData");a(this,"center");a(this,"zoom",1);a(this,"zoomMax",19);a(this,"zoomMin",0);a(this,"latMax",0);a(this,"lngMin",0);a(this,"oldPoint");a(this,"isMoving",!1);a(this,"touchMap",{});a(this,"touchList",[]);a(this,"images",[]);this.center=new x([0,0,0]),t&&(t.mapSource&&(this.mapSource=t.mapSource),t.center&&(this.center=new x(t.center)),t.zoom&&this.setZoom(t.zoom),t.width&&(this.width=t.width),t.height&&(this.height=t.height),t.container&&this.bind(t.container))}bind(t){if(t===void 0)throw new Error("Invalid container");this.container=t,this.setup(),this.resize()}setup(){if(this.container&&(this.container.style.position="relative",this.container.style.width=this.width,this.container.style.height=this.height,!this.canvas)){this.canvas=document.createElement("canvas"),this.container.appendChild(this.canvas),this.canvas.style.width="100%",this.canvas.style.height="100%";let t=this.canvas.getContext("2d");if(!t)return;t.lineWidth=1,t.strokeStyle="#fff",this.canvas.addEventListener("mousedown",this.handlerMouseDown()),this.canvas.addEventListener("mouseup",this.handlerMouseUp()),this.canvas.addEventListener("mousemove",this.handlerMouseMove()),this.canvas.addEventListener("mouseleave",this.handlerMouseLeave()),this.canvas.addEventListener("touchstart",this.handlerTouchStart()),this.canvas.addEventListener("touchend",this.handlerTouchEnd()),this.canvas.addEventListener("touchmove",this.handlerTouchMove()),this.canvas.addEventListener("wheel",this.handlerMouseWheel()),window.addEventListener("resize",this.handlerResize())}}resize(){if(!this.canvas)return;let t=window.devicePixelRatio,e=this.canvas.getBoundingClientRect();this.canvas.width=e.width*t,this.canvas.height=e.height*t,this.useOffScreen&&(this.offScreen||(this.offScreen=document.createElement("canvas"),console.log("offScreen created")),this.offScreen.width=e.width*t,this.offScreen.height=e.height*t);let i=this.canvas.getContext("2d");i&&(i.scale(t,t),!(this.offScreen&&!this.offScreen.getContext("2d"))&&this.draw())}draw(t,e,i=this.zoom){if(!this.canvas||this.useOffScreen&&!this.offScreen)return;let s=this.canvas.getBoundingClientRect(),n=h.getTilePixelByZoom(i),o=h.degrees2meters(this.center.lat,this.center.lng),r=h.meters2tile(o.x,o.y,i),m=h.getMetersPerPixelByZoom(i),g=o.x-(t!=null?t:s.width/2)*m,y=o.y+(e!=null?e:s.height/2)*m,f=h.meters2tile(g,y,i),M=h.tile2meters(r.x,r.y,i),p=h.meter2world(M.x,M.y,i),b=h.meter2world(o.x,o.y,i),E=t!=null?t:s.width/2,T=e!=null?e:s.height/2,I=b.x-p.x,N=b.y-p.y,C=(E-I)%n,Z=Math.ceil((s.width-C)/n)+(C>0?1:0),D=(T-N)%n,z=Math.ceil((s.height-D)/n)+(D>0?1:0),S=this.canvas.getContext("2d");if(!S)return;let l=this.offScreen?this.offScreen.getContext("2d"):S;if(l)this.debug&&(l.lineWidth=1,l.strokeStyle="#f00",l.fillStyle="red",l.textAlign="center",l.textBaseline="middle",l.font="26px Arial");else return;let j=h.tile2meters(f.x,f.y,i),G=j.x-g,$=y-j.y,L=G/m,w=$/m,k=Z*z,O=0;for(let u of this.images)u.src="";this.images=[];for(let u=0;u<Z;u++)for(let d=0;d<z;d++){let R=f.x+u,B=f.y+d,H=this.getMapURL(R,B,i),v=new Image;this.images.push(v),v.addEventListener("load",()=>{this.offScreen?(l.drawImage(v,u*n,d*n,n,n),this.debug&&(l.strokeRect(u*n,d*n,n,n),l.fillText(`${i}/${R}/${B}`,u*n+n/2,d*n+n/2)),O++,O===k&&S.drawImage(this.offScreen,L,w)):(l.drawImage(v,u*n+L,d*n+w,n,n),this.debug&&(l.strokeRect(u*n+L,d*n+w,n,n),l.fillText(`${i}/${R}/${B}`,u*n+L+n/2,d*n+w+n/2)))}),v.src=H}if(this.zoom=i,t!==void 0&&e!==void 0){let u=s.width/2-t,d=s.height/2-e;this.moveCenter(u,d)}}getMapURL(t,e,i){let s=Math.round(i),n=1<<s;return t=t%n,t<0&&(t=n+t),e=e%n,e<0&&(e=n+e),this.mapSource.replace("{x}",String(t)).replace("{y}",String(e)).replace("{z}",String(s))}setGPXData(t,e=!1){!t||isNaN(t.stats.center.lat)||isNaN(t.stats.center.lng)||(this.gpxData=t,e&&(this.adjustCenterByGPXData(),this.adjustZoomLevelByGPXData()))}adjustCenterByGPXData(){if(this.gpxData&&this.gpxData.stats){let t=this.gpxData.stats;this.latMax=t.latMax,this.lngMin=t.lngMin,this.setView(t.center)}}adjustZoomLevelByGPXData(t=1.2){if(!this.canvas||!this.gpxData)return;let e=this.canvas.getBoundingClientRect(),i=this.gpxData.stats,s=h.degrees2meters(i.latMin,i.lngMin),n=h.degrees2meters(i.latMax,i.lngMax),o=(n.x-s.x)*t,r=(n.y-s.y)*t,m=Math.round(h.getZoomByMetersPerPixel(o/e.width)),g=Math.round(h.getZoomByMetersPerPixel(r/e.height));this.zoom=m<g?m:g,console.log(`adjusted zoom level: ${this.zoom}`)}setMapSource(t){this.mapSource=t}setView(t,e){this.center=new x(t),this.setZoom(e)}setZoom(t){t&&t>0&&t<30&&(this.zoom=t)}moveCenter(t,e){let i=h.getMetersPerPixelByZoom(this.zoom),s=h.degrees2meters(this.center.lat,this.center.lng);s.x+=t*i,s.y-=e*i;let n=h.meters2degrees(s.x,s.y);n.lat>85&&(n.lat=85),n.lat<-85&&(n.lat=-85),n.lng>180&&(n.lng-=360),n.lng<-180&&(n.lng+=360),this.center.lat=n.lat,this.center.lng=n.lng}start({offsetX:t,offsetY:e}){this.isMoving=!0,this.oldPoint={x:t,y:e}}stop(){this.oldPoint=void 0,this.isMoving=!1}move({offsetX:t,offsetY:e}){if(this.oldPoint){let i=this.oldPoint.x-t,s=this.oldPoint.y-e;this.moveCenter(i,s)}this.oldPoint={x:t,y:e}}handlerResize(){return()=>{this.resize()}}handlerMouseDown(){return t=>{this.canvas&&(this.canvas.style.cursor="grab"),this.start(t)}}handlerMouseUp(){return()=>{this.stop(),this.canvas&&(this.canvas.style.cursor="")}}handlerMouseMove(){return t=>{this.isMoving&&(this.canvas&&(this.canvas.style.cursor="grabbing"),this.move(t),this.draw())}}handlerMouseLeave(){return()=>{}}handlerTouchStart(){return t=>{if(!this.canvas)return;t.preventDefault();let e=this.canvas.getBoundingClientRect(),i=this.touchMap,s=Object.keys(i).length;for(let n=0;n<t.changedTouches.length;n++){let o=t.changedTouches[n],r={id:o.identifier,x:o.pageX-e.left,y:o.pageY-e.top};i[o.identifier]=r}this.touchList=Object.values(i).sort((n,o)=>n.id-o.id),s===0&&this.start({offsetX:this.touchList[0].x,offsetY:this.touchList[0].y})}}handlerTouchEnd(){return t=>{if(!this.canvas)return;let e=this.touchMap;for(let i=0;i<t.changedTouches.length;i++){let s=t.changedTouches[i];this.touchList.length>0&&this.touchList[0].id===s.identifier&&this.stop(),delete e[s.identifier]}this.touchList=Object.values(e).sort((i,s)=>i.id-s.id),!this.isMoving&&this.touchList.length>0&&this.start({offsetX:this.touchList[0].x,offsetY:this.touchList[0].y})}}handlerTouchMove(){return t=>{if(!this.canvas)return;let e=this.canvas.getBoundingClientRect(),i=this.touchMap;for(let n=0;n<t.changedTouches.length;n++){let o=t.changedTouches[n],r=i[o.identifier];r?(r.old={x:r.x,y:r.y},r.x=o.pageX-e.left,r.y=o.pageY-e.top):(r={id:o.identifier,x:o.pageX-e.left,y:o.pageY-e.top},i[o.identifier]=r)}this.touchList=Object.values(i).sort((n,o)=>n.id-o.id);let s=this.touchList[0];if(s.old){let n=s.old.x-s.x,o=s.old.y-s.y;if(this.touchList.length>=2){let r=this.touchList[1];if(r.old){let m=r.old.x-r.x,g=r.old.y-r.y,y=(n+m)/2,f=(o+g)/2,M=(s.x+r.x)/2,p=(s.y+r.y)/2;this.moveCenter(M-e.width/2+y,p-e.height/2+f);let b=Math.sqrt((s.old.x-r.old.x)**2+(s.old.y-r.old.y)**2),E=Math.sqrt((s.x-r.x)**2+(s.y-r.y)**2),T=h.getMetersPerPixelByZoom(this.zoom),I=h.getZoomByMetersPerPixel(T*b/E);this.draw(M,p,I);return}}}this.move({offsetX:s.x,offsetY:s.y}),this.draw()}}handlerMouseWheel(){return t=>{if(!this.canvas)return;t.preventDefault();let e=t.offsetX,i=t.offsetY,s=this.canvas.getBoundingClientRect(),n=e-s.width/2,o=i-s.height/2;this.moveCenter(n,o);let r=this.zoom;if(t.deltaY<0)r+=.1,r>this.zoomMax&&(r=this.zoomMax);else if(t.deltaY>0)r+=-.1,r<this.zoomMin&&(r=this.zoomMin);else return;this.draw(e,i,r)}}};window&&(window.Mapricorn=c=>new P(c));})();
//# sourceMappingURL=mapricorn.min.js.map
